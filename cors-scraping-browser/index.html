<head>
<title>CORS scraping browser</title>
<!-- 
@author Krzysztof Kotowicz
@see http://blog.kotowicz.net
 -->
<script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
<style type="text/css">
#hello {
	width: 100%;
	height: 90%;
	border: none;
	border-top: 2px solid #ccc;
}

html,body {
	padding: 0;
	margin: 0;
}

#site {
	width: 90%;
}

#nav {
	padding: 0.5em;
}
</style>
</head>
<body>
	<div id=nav>
		<input title="Enter URL" id=site value="http://sourceforge.net/"
			size=90>
		<button id=start>Go!</button>
		<br />
	</div>
	<script>
		var interval; // page loading time

		function clicker() {
			var xhr = new XMLHttpRequest();
			var url = $(this).attr('href');
			console.log(url);
			if (!url.match(/^https?:/)) {
				url = starter.href.replace(/\/$/, '') + '/'
						+ url.replace(/^\//, '');
			} else {
				var domain_re = /:\/\/(.*?)(\/|$)/;
				var url_domain = url.match(domain_re)[1];
				if (url_domain !== starter.href.match(domain_re)[1]) {
					alert('URL is from other domain: ' + url_domain
							+ ', cannot load.');
					return false;
				}
			}
			if (interval) {
				clearInterval(interval);
				interval = null;
			}

			$("#site").val(url);
			write("<p>loading " + url + "</p>");
			xhr.open("GET", url, true);
			xhr.onreadystatechange = display;
			xhr.send(null);

		}

		function write(text) {
			$('#hello').remove();
			$('<iframe id=hello>').load(function() {
				this.contentDocument.body.innerHTML = "";
				this.contentDocument.head.innerHTML = "";
				this.contentDocument.write(text);

			}).appendTo('body');

		}

		function display(event) {
			var xhr = event.target;

			try {
				if (xhr.readyState === 4) {
					if (xhr.status === 200) {
						var text = pre(xhr.responseText);
						write(text);
						var f = document.getElementById('hello');
						post(f.contentDocument);
						if (interval) {
							clearInterval(interval);
							interval = null;
						}

						interval = setInterval(function() {
							post(f.contentDocument)
						}, 1000);
					} else {
						alert("Cannot load ("
								+ xhr.statusText
								+ ").\nBrowser supports websites that allow CORS requests (Access-Control-Allow-Origin: *)");
					}
				}
			} catch (e) {
				console.log(e);
			}
		}

		function pre(text) {
			text = text
					.replace(
							/\<body.*?\>/,
							"\0<marquee><center>Content is modified by CORS scraping browser!</center></marquee>");
			text = text.replace("<head>",
					"<head><base href='" + starter.href + "'>");
			// remove flash 
			text = text.replace(/\<object.*?\<\/object\>/gi, '[removed Flash]');

			return text;
		}

		function post(d) {
			$('a', d.body).unbind('click').click(clicker).bind('click', false);
		}

		var starter = {
			href : ''
		};

		$("#start").click(function() {
			starter = {
				'href' : $('#site').val()
			};
			clicker.apply(starter);
		});
	</script>
</body>